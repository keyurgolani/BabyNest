# BabyNest API Development Dockerfile
# Optimized for hot-reload with Docker Compose Watch

FROM node:20-alpine

# Install dependencies required for native modules and database connectivity
RUN apk add --no-cache python3 make g++ netcat-openbsd openssl openssl-dev

WORKDIR /app

# Copy package files for dependency installation
COPY package.json package-lock.json ./
COPY apps/api/package.json ./apps/api/
COPY packages/types/package.json ./packages/types/
COPY packages/validators/package.json ./packages/validators/
COPY packages/tsconfig/package.json ./packages/tsconfig/
COPY packages/eslint-config/package.json ./packages/eslint-config/

# Install all dependencies
RUN npm ci

# Copy source code
COPY . .

# Build shared packages (types and validators)
RUN npm run build --workspace=@babynest/types --workspace=@babynest/validators || true

# Generate Prisma client
RUN npx prisma generate --schema=apps/api/prisma/schema.prisma

# Copy entrypoint script
COPY infra/docker/api/docker-entrypoint.sh /app/docker-entrypoint.sh
RUN chmod +x /app/docker-entrypoint.sh

# Expose ports
EXPOSE 3000 9229

WORKDIR /app/apps/api

# Use entrypoint for migrations, then start dev server with watch mode
ENTRYPOINT ["/app/docker-entrypoint.sh"]
CMD ["npm", "run", "dev"]
